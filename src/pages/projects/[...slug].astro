---
import BaseLayout from '../../layouts/BaseLayout.astro';
import DocumentCard from '../../components/DocumentCard.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const projects = (await getCollection('projects')).filter((p) => p.id.endsWith('.mdx'));
  return projects.map((p) => ({ params: { slug: p.slug } }));
}

const { slug } = Astro.params;
const projects = (await getCollection('projects')).filter((p) => p.id.endsWith('.mdx'));
const entry = projects.find((p) => p.slug === slug);
if (!entry) throw new Error(`Missing project: ${slug}`);

const { Content, headings } = await render(entry);

const tocHeadings = (headings ?? []).filter((h) => h.depth >= 2 && h.depth <= 4);
const documents = entry.data.documents ?? [];
---

<BaseLayout
  title={`${entry.data.title} | Kenneth Wong Cun Wi`}
  description={entry.data.subtitle}
  canonicalPath={`/projects/${entry.slug}/`}
  activeNav="projects"
>
  <section class="section project-page">
    <div class="container">
      {entry.data.thumbnail ? (
        <header class="project-hero" aria-label="Project header">
          <div class="project-hero-media">
            <img src={entry.data.thumbnail} alt={`${entry.data.title} thumbnail`} loading="lazy" />
            <div class="project-hero-overlay" aria-hidden="true"></div>
            <div class="project-hero-text">
              <h1 class="project-hero-title">{entry.data.title}</h1>
              {entry.data.subtitle ? <p class="project-hero-subtitle">{entry.data.subtitle}</p> : null}
            </div>
          </div>
        </header>
      ) : (
        <div class="section-head">
          <h2>{entry.data.title}</h2>
          <p class="muted">{entry.data.subtitle}</p>
        </div>
      )}

      <div class="project-grid">
        {tocHeadings.length ? (
          <aside class="project-aside" aria-label="Project sidebar">
            <aside class="toc-card" aria-label="Contents">
              <div class="toc-top">
                <p class="toc-title">Contents</p>
              </div>
              <nav class="toc" aria-label="On this page">
                {tocHeadings.map((h) => (
                  <a class={`toc-level-${h.depth}`} href={`#${h.slug}`}>
                    {h.text}
                  </a>
                ))}
              </nav>

              <script is:inline>
                (() => {
                  const toc = document.querySelector('.project-page .toc');
                  if (!toc) return;

                  const links = Array.from(toc.querySelectorAll('a[href^="#"]'));
                  const entries = links
                    .map((link) => {
                      const id = decodeURIComponent(link.getAttribute('href').slice(1));
                      const el = document.getElementById(id);
                      return el ? { link, el, id } : null;
                    })
                    .filter(Boolean);

                  if (!entries.length) return;

                  const setActive = (activeId) => {
                    for (const { link, id } of entries) {
                      const isActive = id === activeId;
                      link.classList.toggle('is-active', isActive);
                      if (isActive) link.setAttribute('aria-current', 'true');
                      else link.removeAttribute('aria-current');
                    }
                  };

                  const update = () => {
                    const offset = 140;
                    let current = entries[0].id;

                    for (const { el, id } of entries) {
                      const top = el.getBoundingClientRect().top;
                      if (top <= offset) current = id;
                      else break;
                    }

                    setActive(current);
                  };

                  let ticking = false;
                  const onScroll = () => {
                    if (ticking) return;
                    ticking = true;
                    requestAnimationFrame(() => {
                      ticking = false;
                      update();
                    });
                  };

                  window.addEventListener('scroll', onScroll, { passive: true });
                  window.addEventListener('resize', onScroll, { passive: true });
                  window.addEventListener('hashchange', () => setTimeout(update, 0));
                  toc.addEventListener('click', () => setTimeout(update, 0));

                  update();
                })();
              </script>
            </aside>

            {documents.length ? (
              <aside class="toc-card" aria-label="Documents">
                <div class="toc-top">
                  <p class="toc-title">Documents</p>
                </div>
                <div class="doc-list" aria-label="Document links">
                  {documents.map((d) => (
                    <DocumentCard href={d.url} title={d.title} subtitle={d.subtitle} thumbnail={d.thumbnail} />
                  ))}
                </div>
              </aside>
            ) : null}
          </aside>
        ) : null}

        <article class="panel prose project-content">
          <Content />
        </article>
      </div>

      <div class="section-foot">
        <a class="button" href="/projects/">‚Üê Back to projects</a>
      </div>
    </div>
  </section>
</BaseLayout>
